{% extends "base.html" %}
{% block content %}

<!-- Post Card -->
<div class="card mb-4">
  <div class="card-body">
    <h3>{{ post.title }}</h3>
    <p>{{ post.content }}</p>
    <p class="text-muted">
      By <a href="{{ url_for('main.user_profile', user_id=post.author.id) }}">{{ post.author.username }}</a>
      · {{ post.created_at.strftime("%Y-%m-%d %H:%M") }}
      {% if post.updated_at and post.updated_at != post.created_at %}
        · <i class="bi bi-pencil"></i> Updated {{ post.updated_at.strftime("%Y-%m-%d %H:%M") }}
      {% endif %}
    </p>
  </div>
</div>

<!-- Like Button -->
<button id="like-btn" 
        data-post-id="{{ post.id }}" 
        data-csrf="{{ form.csrf_token._value() }}" 
        class="btn btn-sm {% if current_user in post.likes %}btn-success{% else %}btn-outline-success{% endif %}">
    <i class="bi bi-hand-thumbs-up"></i> (<span id="like-count">{{ post.likes|length }}</span>)
</button>

<!-- Comment Form -->
<form id="comment-form" data-post-id="{{ post.id }}" data-csrf="{{ form.csrf_token._value() }}">
    {{ form.hidden_tag() }}
    <div class="mb-3">
        {{ form.content(class="form-control", rows=3, placeholder="Write your comment...") }}
    </div>
    {{ form.submit(class="btn btn-primary mt-2") }}
</form>

<!-- Comment List -->
{% macro render_comment(comment, level=0) %}
<li class="list-group-item ms-{{ level * 4 }}" id="comment-{{ comment.id }}">
  <strong>{{ comment.user.username }}</strong>:
  <span class="comment-content">{{ comment.content }}</span>
  <br>
  <small class="text-muted">{{ comment.created_at.strftime("%Y-%m-%d %H:%M") }}</small>

  {% if current_user.is_authenticated %}
    <div class="mt-1">
      <button class="btn btn-sm btn-link reply-btn" data-id="{{ comment.id }}">Reply</button>
      {% if comment.user == current_user %}
        <button class="btn btn-sm btn-link edit-comment" data-id="{{ comment.id }}">Edit</button>
        <button class="btn btn-sm btn-link text-danger delete-comment" data-id="{{ comment.id }}">Delete</button>
      {% endif %}
    </div>
  {% endif %}

  <!-- reply form container (valid inside li) -->
  <div class="reply-form-container" id="reply-form-{{ comment.id }}"></div>

  {% if comment.replies %}
    <ul class="list-group mt-2">
      {% for reply in comment.replies.order_by(Comment.created_at.asc()).all() %}
        {{ render_comment(reply, level + 1) }}
      {% endfor %}
    </ul>
  {% endif %}
</li>
{% endmacro %}

<ul id="comment-list" class="list-group mb-3">
  {% for comment in comments %}
    {{ render_comment(comment) }}
    <!-- Reply form container belongs INSIDE the loop -->
    <div class="reply-form-container" id="reply-form-{{ comment.id }}"></div>
  {% endfor %}
</ul>

{% endblock %}
