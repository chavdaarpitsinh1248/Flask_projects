{% extends "base.html" %}
{% block title %}Edit Chapter - {{ chapter.title }}{% endblock %}

{% block content %}
<section class="edit-chapter container my-4">

    <h2 class="mb-3 fw-bold">‚úèÔ∏è Edit Chapter: {{ chapter.title }}</h2>

    <form method="post" enctype="multipart/form-data" id="editChapterForm">
        {{ form.hidden_tag() }}

        <!-- Title -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Chapter Title</label>
            {{ form.title(class="form-control", value=chapter.title) }}
        </div>

        <!-- Number -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Chapter Number</label>
            {{ form.number(class="form-control", value=chapter.number) }}
        </div>

        <!-- Current Images (Draggable) -->
        <div class="mb-3">
            <label class="form-label fw-semibold">Reorder Pages</label>
            <p class="text-muted small">Drag images to rearrange page order.</p>

            <div id="sortableImages" class="image-sort-container">
                {% for img in image_files %}
                <div class="page-item" data-file="{{ img }}">
                    <img src="{{ img }}" class="page-thumb">
                </div>
                {% endfor %}
            </div>

            <!-- Hidden input to store new order -->
            <input type="hidden" name="image_order" id="imageOrder">
        </div>

        <!-- Upload new images -->
        <div class="mb-4">
            <label class="form-label fw-semibold">Add / Replace Images</label>
            {{ form.content(class="form-control", multiple=True) }}
            <small class="text-muted">Uploading new images will be added after existing ones unless replaced
                manually.</small>
        </div>

        <button type="submit" class="btn btn-success px-4">üíæ Update Chapter</button>
    </form>

    <!-- Delete Button -->
    <form method="post" action="{{ url_for('author.delete_chapter', chapter_id=chapter.id) }}"
        onsubmit="return confirm('Are you sure you want to delete this chapter?');" class="mt-3">
        <button type="submit" class="btn btn-danger">üóë Delete Chapter</button>
    </form>

    <div class="mt-3">
        <a href="{{ url_for('author.view_chapters', manga_id=manga.id) }}" class="text-decoration-none">
            ‚¨Ö Back to Chapters
        </a>
    </div>

</section>

<style>
    /* Container for draggable items */
    .image-sort-container {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        background: #f8f9fa;
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #ddd;
    }

    /* Each image wrapper */
    .page-item {
        width: 120px;
        height: 180px;
        border-radius: 8px;
        overflow: hidden;
        cursor: grab;
        border: 2px solid transparent;
        transition: border 0.2s;
    }

    .page-item.dragging {
        opacity: 0.5;
    }

    .page-item:hover {
        border: 2px solid #0d6efd;
    }

    /* The actual thumbnail */
    .page-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>

<!-- Drag Sort Script -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("sortableImages");
        const orderInput = document.getElementById("imageOrder");

        let dragging = null;

        container.querySelectorAll(".page-item").forEach(item => {
            item.draggable = true;

            item.addEventListener("dragstart", () => {
                dragging = item;
                item.classList.add("dragging");
            });

            item.addEventListener("dragend", () => {
                dragging.classList.remove("dragging");
                dragging = null;
                saveOrder();
            });

            item.addEventListener("dragover", (e) => {
                e.preventDefault();
                const after = getDragAfter(container, e.clientX, e.clientY);
                if (after == null) {
                    container.appendChild(dragging);
                } else {
                    container.insertBefore(dragging, after);
                }
            });
        });

        function getDragAfter(container, x, y) {
            const items = [...container.querySelectorAll(".page-item:not(.dragging)")];

            return items.find(item => {
                const box = item.getBoundingClientRect();
                return y < box.top + box.height / 2;
            });
        }

        function saveOrder() {
            const files = [...container.querySelectorAll(".page-item")]
                .map(i => i.dataset.file);
            orderInput.value = JSON.stringify(files);
        }

        saveOrder();
    });
</script>

{% endblock %}