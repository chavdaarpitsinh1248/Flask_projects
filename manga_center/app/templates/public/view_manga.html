{% extends "base.html" %}
{% block title %}{{ manga.title }}{% endblock %}

{% block content %}
<section class="view-manga">
    <h2>{{ manga.title }}</h2>

    <img src="{{ manga.cover_url }}" alt="{{ manga.title }}"
        style="max-width: 200px; border-radius: 10px; margin-bottom: 10px;">

    {% if current_user.is_authenticated %}
    <button class="bookmark-btn btn-warning" data-manga-id="{{ manga.id }}"
        data-is-bookmarked="{{ 'true' if is_bookmarked else 'false' }}">{{ 'Remove Bookmark' if is_bookmarked else 'Add
        to Bookmarks' }}</button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.querySelector('.bookmark-btn');
            if (!btn) return;

            btn.addEventListener('click', async () => {
                const mangaId = btn.dataset.mangaId;
                try {
                    const res = await fetch(`/bookmark/${mangaId}`, {
                        method: "POST",
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        }
                    });
                    const data = await res.json();
                    if (data.status === 'success') {
                        if (data.action === 'added') {
                            btn.textContent = '★ Remove Bookmark';
                            showToast("Added to your Library!", "success");

                            btn.dataset.isBookmarked = 'true';
                        } else {
                            btn.textContent = '☆ Add to Bookmarks';
                            showToast("Removed from your Library!", "info");

                            btn.dataset.isBookmarked = 'false';
                        }
                    } else if (data.status === 'error') {
                        alert(data.message || 'Something went wrong.');
                    }
                } catch (err) {
                    console.error('Error:', err);
                }
            });
        });
    </script>
    {% else %}
    <a href="{{ url_for('users.login') }}" class="btn btn-outline-primary">Bookmark</a>
    {% endif %}

    <!-- Author Info -->
    <p>
        <strong>Author:</strong>
        <a href="{{ url_for('public.view_author', author_id=manga.author.id) }}">
            {{ manga.author.user.username }}
            {% if manga.author.pen_name %}
            ({{ manga.author.pen_name }})
            {% endif %}
        </a>
    </p>

    <p>{{ manga.description }}</p>

    <h3>Chapters</h3>
    {% if chapters %}
    <ul>
        {% for chapter in chapters %}
        <li>
            <a href="{{ url_for('public.read_chapter', chapter_id=chapter.id) }}">
                Chapter {{ chapter.number }}: {{ chapter.title }}
            </a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>No chapters available yet.</p>
    {% endif %}
</section>



{% endblock %}