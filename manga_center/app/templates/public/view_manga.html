{% extends "base.html" %}
{% block title %}{{ manga.title }}{% endblock %}

{% block content %}
<div class="container my-4">

    <!-- Header Row -->
    <div class="row g-4">
        <!-- Manga Cover -->
        <div class="col-md-4 text-center">
            <img src="{{ manga.cover_url }}" alt="{{ manga.title }}" class="img-fluid rounded shadow"
                style="max-height: 350px; object-fit: cover;">

            <!-- Bookmark Button -->
            <div class="mt-3">
                {% if current_user.is_authenticated %}
                <button class="btn btn-warning bookmark-btn fw-semibold" data-manga-id="{{ manga.id }}"
                    data-is-bookmarked="{{ 'true' if is_bookmarked else 'false' }}">
                    {% if is_bookmarked %}
                    ★ Remove Bookmark
                    {% else %}
                    ☆ Add to Bookmarks
                    {% endif %}
                </button>
                {% else %}
                <a href="{{ url_for('users.login') }}" class="btn btn-outline-primary">
                    Login to Bookmark
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Manga Details -->
        <div class="col-md-8">
            <h2 class="fw-bold">{{ manga.title }}</h2>

            <p class="text-muted small text-center">{{ manga.genre_names }}</p>

            <p class="text-muted mb-1">
                <strong>Author:</strong>
                <a href="{{ url_for('public.view_author', author_id=manga.author.id) }}"
                    class="text-decoration-none fw-semibold">
                    {{ manga.author.user.username }}
                    {% if manga.author.pen_name %}
                    ({{ manga.author.pen_name }})
                    {% endif %}
                </a>
            </p>

            <p class="mt-3">{{ manga.description }}</p>
        </div>
    </div>

    <!-- Line Divider -->
    <hr class="my-4">

    <!-- Toggle -->
    <div class="d-flex justify-content-end mb-3">
        <button id="toggle-order-btn" class="btn btn-outline-secondary btn-sm">
            Sort: Newest First
        </button>
    </div>

    <!-- Chapters Section -->
    <h3 class="mb-3 fw-bold">Chapters</h3>

    {% if chapters %}
    <div id="chapter-list" class="list-group shadow-sm">
        {% for chapter in chapters %}
        <a href="{{ url_for('public.read_chapter', chapter_id=chapter.id) }}"
            class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
            data-number="{{ chapter.number }}">
            <span>
                <strong>Chapter {{ chapter.number }}</strong>: {{ chapter.title }}
            </span>
            <span class="badge bg-primary">Read</span>
        </a>
        {% endfor %}
    </div>

    {% else %}
    <p class="text-muted">No chapters available yet.</p>
    {% endif %}

</div>

<!-- Bookmark JavaScript -->
{% if current_user.is_authenticated %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('.bookmark-btn');
        if (!btn) return;

        btn.addEventListener('click', async () => {
            const mangaId = btn.dataset.mangaId;

            try {
                const res = await fetch(`/bookmark/${mangaId}`, {
                    method: "POST",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest",
                        "X-CSRFToken": "{{ csrf_token() }}"
                    }
                });

                const data = await res.json();

                if (data.status === "success") {
                    if (data.action === "added") {
                        btn.textContent = "★ Remove Bookmark";
                        btn.classList.add("btn-warning");
                        showToast("Added to your Library!", "success");

                        btn.dataset.isBookmarked = "true";
                    } else {
                        btn.textContent = "☆ Add to Bookmarks";
                        btn.classList.remove("btn-warning");
                        btn.classList.add("btn-outline-warning");
                        showToast("Removed from your Library!", "info");

                        btn.dataset.isBookmarked = "false";
                    }
                }
            } catch (err) {
                console.error("Error:", err);
            }
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.getElementById('toggle-order-btn');
        const list = document.getElementById('chapter-list');

        // Initial state = DESC (newest first)
        let descending = true;

        btn.addEventListener('click', () => {
            const items = Array.from(list.children);

            // Sort using data-number attribute
            items.sort((a, b) => {
                const numA = parseFloat(a.dataset.number);
                const numB = parseFloat(b.dataset.number);
                return descending ? numA - numB : numB - numA;
            });

            // Clear and re-append
            list.innerHTML = '';
            items.forEach(item => list.appendChild(item));

            // Flip the toggle state
            descending = !descending;

            // Update button label
            btn.textContent = descending
                ? "Sort: Newest First"
                : "Sort: Oldest First";
        });
    });
</script>

{% endif %}
{% endblock %}