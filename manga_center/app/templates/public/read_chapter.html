{% extends "base.html" %}
{% block title %}{{ manga.title }} - Chapter {{ chapter.number }}{% endblock %}

{% block content %}
<section class="chapter-reader" style="text-align: center;">

    <h2>{{ manga.title }} - Chapter {{ chapter.number }}</h2>

    <!-- Navigation Links (Top) -->
    <div class="chapter-nav" style="margin-bottom: 20px;">
        {% if prev_chapter %}
        <a href="{{ url_for('public.read_chapter', chapter_id=prev_chapter.id) }}" style="margin-right: 20px;">⬅ Prev
            Chapter</a>
        {% endif %}
        <a href="{{ url_for('public.view_manga', manga_id=manga.id) }}">Back to Manga</a>
        {% if next_chapter %}
        <a href="{{ url_for('public.read_chapter', chapter_id=next_chapter.id) }}" style="margin-left: 20px;">Next
            Chapter ➡</a>
        {% endif %}
    </div>

    <!-- Chapter Images -->
    {% for img in image_urls %}
    <img src="{{ img }}" alt="Page {{ loop.index }}" style="max-width: 90%; margin: 10px 0;">
    {% endfor %}

    <!-- Navigation Links (Bottom) -->
    <div class="chapter-nav" style="margin-top: 20px;">
        {% if prev_chapter %}
        <a href="{{ url_for('public.read_chapter', chapter_id=prev_chapter.id) }}" style="margin-right: 20px;">⬅ Prev
            Chapter</a>
        {% endif %}
        <a href="{{ url_for('public.view_manga', manga_id=manga.id) }}">Back to Manga</a>
        {% if next_chapter %}
        <a href="{{ url_for('public.read_chapter', chapter_id=next_chapter.id) }}" style="margin-left: 20px;">Next
            Chapter ➡</a>
        {% endif %}
    </div>

</section>

<section id="comments-section">
    <h3>Comments</h3>

    {% if current_user.is_authenticated %}
    <div id="new-comment">
        <textarea id="comment-content" placeholder="Write a comment..."></textarea>
        <button id="submit-comment" data-chapter-id="{{ chapter.id }}">Post</button>
    </div>
    {% else %}
    <p><a href="{{ url_for('users.login') }}">Login</a> to comment.</p>
    {% endif %}

    <div id="comments-list"></div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const chapterId = {{ chapter.id | tojson
    }};
    const list = document.getElementById("comments-list");

    function loadComments() {
        fetch(`/comments/${chapterId}`)
            .then(res => res.json())
            .then(data => {
                list.innerHTML = renderComments(data);
            });
    }

    function renderComments(comments) {
        return comments.map(c => `
          <div class="comment">
            <p class="meta">
                <a href="/user/${c.user_id}">
                    ${c.pen_name ? c.pen_name : c.username}
                    ${c.is_author ? '<span class="author-tag">AUTHOR</span>' : ''}
                </a>
                <small>${c.created_at}</small>
            </p>
            <p>${c.content}</p>
            <button class="reply-btn" data-id="${c.id}">Reply</button>
            <div class="replies">${renderComments(c.replies || [])}</div>
          </div>
        `).join("");
    }

    document.getElementById("submit-comment")?.addEventListener("click", () => {
        const content = document.getElementById("comment-content").value.trim();
        if (!content) return showToast("Comment cannot be empty", "warning");

        fetch("/comments/add", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ content, chapter_id: chapterId })
        })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    showToast("Comment added", "success");
                    document.getElementById("comment-content").value = "";
                    loadComments();
                } else {
                    showToast("Failed to add comment", "error");
                }
            });
    });

    // Reply handler
    list.addEventListener("click", (e) => {
        if (e.target.classList.contains("reply-btn")) {
            const parentId = e.target.dataset.id;
            const box = document.createElement("div");
            box.innerHTML = `
                <textarea class="reply-input" placeholder="Write a reply..."></textarea>
                <button class="send-reply" data-parent="${parentId}">Send</button>
            `;
            e.target.after(box);
        } else if (e.target.classList.contains("send-reply")) {
            const parentId = e.target.dataset.parent;
            const content = e.target.previousElementSibling.value.trim();
            if (!content) return showToast("Reply cannot be empty", "warning");

            fetch("/comments/add", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ content, chapter_id: chapterId, parent_id: parentId })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        showToast("Reply Added", "success");
                        loadComments();
                    } else {
                        showToast("Failed to reply", "error");
                    }
                });
        }
    });

    loadComments();
});
</script>

{% endblock %}