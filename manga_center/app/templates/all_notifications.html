{% extends "base.html" %}
{% block title %}Notifications{% endblock %}

{% block content %}
<div>
    <button id="mark-all-read" class="btn btn-sm btn-outline-secondary mb-3">Mark All as Read</button>

</div>
<section class="notifications-section container mt-4">
    <h2>Your Notifications</h2>
    {% if not notifications %}
    <p class="text-muted">You have no notifications yet.</p>
    {% endif %}

    {% include "components/notifications.html" %}
</section>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {

        const notifContainer = document.querySelector(".notifications-list");
        if (!notifContainer) return;

        // ----------------------
        // MARK SINGLE NOTIFICATION READ
        // ----------------------
        notifContainer.addEventListener("click", async (e) => {
            if (e.target.classList.contains("mark-read-btn")) {
                const btn = e.target;
                const notifId = btn.dataset.id;

                try {
                    const res = await fetch(`/notifications/${notifId}/mark_read`, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "Content-Type": "application/json"
                        }
                    });

                    const data = await res.json();
                    if (data.success) {
                        const card = btn.closest(".notification-card");
                        card.classList.remove("unread");
                        btn.remove();
                        updateNotifBadge(-1);
                    }
                } catch (err) {
                    console.error(err);
                }
            }
        });

        // ----------------------
        // DELETE NOTIFICATION
        // ----------------------
        notifContainer.addEventListener("click", async (e) => {
            if (e.target.classList.contains("delete-btn")) {
                const btn = e.target;
                const notifId = btn.dataset.id;

                if (!confirm("Delete this notification?")) return;

                try {
                    const res = await fetch(`/notifications/${notifId}/delete`, {
                        method: "POST",
                        headers: {
                            "X-Requested-With": "XMLHttpRequest",
                            "Content-Type": "application/json"
                        }
                    });

                    const data = await res.json();
                    if (data.success) {

                        // If unread, decrease badge
                        const card = btn.closest(".notification-card");
                        if (card.classList.contains("unread")) {
                            updateNotifBadge(-1);
                        }

                        card.remove();
                    }
                } catch (err) {
                    console.error(err);
                }
            }
        });

        // ----------------------
        // MARK ALL READ
        // ----------------------
        const markAllBtn = document.getElementById("mark-all-read");
        if (markAllBtn) {
            markAllBtn.addEventListener("click", async () => {
                try {
                    const res = await fetch("/notifications/mark_all_read", {
                        method: "POST",
                        headers: { "X-Requested-With": "XMLHttpRequest" }
                    });

                    const data = await res.json();
                    if (data.success) {
                        document
                            .querySelectorAll(".notification-card.unread")
                            .forEach(c => c.classList.remove("unread"));

                        document
                            .querySelectorAll(".mark-read-btn")
                            .forEach(btn => btn.remove());

                        // Reset badge count
                        updateNotifBadge("clear");
                    }
                } catch (err) {
                    console.error(err);
                }
            });
        }

        // ----------------------
        // UPDATE HEADER BADGE
        // ----------------------
        function updateNotifBadge(amount) {
            const badge = document.getElementById("notif-count");
            if (!badge) return;

            if (amount === "clear") {
                badge.textContent = "0";
                badge.classList.add("d-none");
                return;
            }

            let count = parseInt(badge.textContent);
            count += amount;

            if (count <= 0) {
                badge.classList.add("d-none");
            } else {
                badge.classList.remove("d-none");
                badge.textContent = count;
            }
        }

    });
</script>
{% endblock %}