{% extends "base.html" %}
{% block title %}{{ manga.title }} - Chapter {{ chapter.number }}{% endblock %}
{% block content %}
<div class="text-center mb-4">
    <h2 class="fw-bold">{{ manga.title }} - Chapter {{ chapter.number }}</h2>

    <div class="d-flex justify-content-center gap-2 my-3">
        {% if prev_chapter %}
        <a href="{{ url_for('main.chapter_reader', chapter_id=prev_chapter.id) }}" class="btn btn-outline-secondary">â¬…
            Previous</a>
        {% endif %}
        <a href="{{ url_for('main.manga_detail', manga_id=manga.id) }}" class="btn btn-primary">ðŸ“š All Chapters</a>
        {% if next_chapter %}
        <a href="{{ url_for('main.chapter_reader', chapter_id=next_chapter.id) }}"
            class="btn btn-outline-secondary">Next âž¡</a>
        {% endif %}
    </div>
</div>

<div class="text-center mb-5">
    {% for p in pages %}
    <img src="{{ url_for('static', filename=p.image_path) }}" alt="Page {{ p.page_number }}"
        class="img-fluid rounded shadow mb-3" loading="lazy">
    {% else %}
    <p class="text-muted">No pages found for this chapter.</p>
    {% endfor %}
</div>

<hr>

<h3 class="mb-3">ðŸ’¬ Comments</h3>

{% if current_user.is_authenticated %}
<form action="{{ url_for('main.post_comment', chapter_id=chapter_id) }}" method="POST" class="mb-4">
    <div class="mb-3">
        <textarea name="content" rows="3" class="form-control" placeholder="Write your comment..." required></textarea>
    </div>
    <button type="submit" class="btn btn-success">Post Comment</button>
</form>
{% else %}
<p><a href="{{ url_for('auth.login') }}">Log in</a> to post a comment.</p>
{% endif %}

{% for comment in chapter.comments|sort(attribute='created_at', reverse=True) %}
<div class="card mb-3 shadow-sm">
    <div class="card-body">
        <div class="d-flex justify-content-between">
            <strong>{{ comment.user.username }}</strong>
            <small class="text-muted">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</small>
        </div>
        <p class="mt-2">{{ comment.content }}</p>
        {% if current_user.is_authenticated and (comment.user_id == current_user.id or current_user.role == "admin") %}
        <a href="{{ url_for('main.delete_comment', comment_id=comment.id) }}" class="text-danger small">Delete</a>
        {% endif %}
    </div>
</div>
{% else %}
<p class="text-muted">No comments yet. Be the first!</p>
{% endfor %}
{% endblock %}