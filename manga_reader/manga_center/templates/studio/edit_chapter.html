{% extends "base.html" %}
{% block content %}
<h2>Edit Chapter: {{ chapter.title }}</h2>

<form id="chapterForm" method="POST" enctype="multipart/form-data"
    action="{{ url_for('studio.edit_chapter', chapter_id=chapter.id) }}">

    <h4>Chapter Info</h4>
    <label>Chapter Number:</label>
    <input type="number" name="number" value="{{ chapter.number }}" required><br><br>

    <label>Chapter Title:</label>
    <input type="text" name="title" value="{{ chapter.title }}"><br><br>

    <h4>Existing Pages</h4>
    <ul id="pageList" style="list-style:none; padding:0;">
        {% for page in chapter.pages|sort(attribute='page_number') %}
        <li data-page-id="{{ page.id }}" style="margin-bottom:10px; border:1px solid #ccc; padding:5px; cursor:grab;">
            <img src="{{ url_for('static', filename=page.image) }}" width="100">
            <input type="hidden" name="page_order_{{ page.id }}" value="{{ page.page_number }}">
            <button type="button" onclick="deletePage('{{ page.id }}')">Delete</button>
        </li>
        {% endfor %}
    </ul>

    <h4>Add New Pages</h4>
    <div id="newPagesContainer">
        <input type="file" name="new_pages" multiple>
    </div>
    <button type="button" onclick="addNewFileInput()">Add Another File Input</button>

    <br><br>
    <button type="submit">Save Changes</button>
</form>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    // Drag-and-drop pages
    const pageList = document.getElementById('pageList');
    new Sortable(pageList, {
        animation: 150,
        onEnd: function () {
            const items = pageList.querySelectorAll('li');
            items.forEach((li, index) => {
                li.querySelector('input[type="hidden"]').value = index + 1;
            });
        }
    });

    // Add new file input dynamically
    function addNewFileInput() {
        const container = document.getElementById('newPagesContainer');
        const input = document.createElement('input');
        input.type = 'file';
        input.name = 'new_pages';
        input.multiple = true;
        container.appendChild(input);
        container.appendChild(document.createElement('br'));
    }

    // Delete page
    function deletePage(pageId) {
        if (confirm("Are you sure you want to delete this page?")) {
            fetch(`/studio/page/delete/${pageId}`, { method: 'POST' })
                .then(res => location.reload());
        }
    }
</script>
{% endblock %}